@page "/evm/stations/operations"
@model ElectricVehicleDealer.Presentation.Pages.Evm.Dealers.OperationsModel
@using System.Linq
@{
    ViewData["Title"] = "Điều hành station - EVM";
    ViewData["PageTitle"] = "Vận hành mạng lưới station";
    ViewData["PageDescription"] = "Theo dõi hoạt động bán hàng, tồn kho trưng bày và trạng thái phục vụ khách tại từng station.";

    var totalStations = Model.TotalStations;
    var activeStations = Model.ActiveStations;
    var idleStations = Model.StationOverview.Count(o => !o.HasInventory);
    var lowInventoryStations = Model.StationsWithLowInventory;
}

@section PageActions {
    <button class="btn-primary-gradient">Lập lịch kiểm tra cơ sở</button>
    <button class="btn-secondary-soft">Xuất báo cáo vận hành</button>
}

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Tổng quan vận hành station</h2>
            <p>Số liệu cập nhật từ hệ thống station và phân bổ đội xe trưng bày.</p>
        </div>
    </div>
    <div class="panel-body grid-3">
        <div class="stat-card">
            <span>Station đang mở bán</span>
            <h3>@activeStations/@totalStations</h3>
            <span class="kpi-trend">@(totalStations == 0 ? "Chưa cấu hình station" : $"{totalStations - activeStations} station tạm ngưng")</span>
        </div>
        <div class="stat-card">
            <span>Xe sẵn sàng trưng bày</span>
            <h3>@Model.TotalVehiclesReady</h3>
            <span class="kpi-trend">@(idleStations > 0 ? $"{idleStations} station chưa có xe" : "Tất cả station đã có xe")</span>
        </div>
        <div class="stat-card">
            <span>Cảnh báo tồn kho</span>
            <h3>@lowInventoryStations</h3>
            <span class="badge @(lowInventoryStations > 0 ? "warning" : "success")">
                @(lowInventoryStations > 0 ? "Cần điều phối bổ sung" : "Tồn kho ổn định")
            </span>
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Danh sách station</h2>
            <p>Chi tiết tình trạng phục vụ khách, tồn kho trưng bày và liên hệ phụ trách.</p>
        </div>
    </div>
    <div class="panel-body">
        @if (Model.StationOverview.Any())
        {
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Station</th>
                        <th>Địa điểm</th>
                        <th>Mẫu xe mở bán</th>
                        <th>Xe sẵn sàng</th>
                        <th>Tổng xe</th>
                        <th>Liên hệ</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var station in Model.StationOverview)
                    {
                        var statusClass = station.IsActive
                            ? (station.HasLowInventory ? "warning" : "success")
                            : "danger";

                        <tr>
                            <td>@station.StationName</td>
                            <td>@station.Location</td>
                            <td>@station.DistinctModels</td>
                            <td>
                                <strong>@station.ActiveVehicles</strong>
                                @if (station.HasLowInventory)
                                {
                                    <span class="badge warning">Thấp</span>
                                }
                            </td>
                            <td>@station.TotalVehicles</td>
                            <td>@(string.IsNullOrWhiteSpace(station.ContactNumber) ? "Đang cập nhật" : station.ContactNumber)</td>
                            <td>
                                <span class="badge @statusClass">
                                    @(station.IsActive
                                        ? (station.HasInventory ? "Đang phục vụ" : "Chưa có xe")
                                        : "Tạm ngưng")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="crud-empty">
                Chưa có station nào được cấu hình. Vui lòng thêm station trong mục quản trị.
            </div>
        }
    </div>
</div>

<div class="split-2">
    <div class="panel soft">
        <div class="panel-header">
            <div>
                <h2>Lịch công việc station</h2>
                <p>Ghi chú nhanh để phối hợp bảo trì showroom, chuẩn bị sự kiện bán hàng.</p>
            </div>
        </div>
        <div class="panel-body">
            <div class="form-grid">
                <div class="form-control-modern">
                    <label>Station</label>
                    <select>
                        @foreach (var station in Model.StationOverview)
                        {
                            <option value="@station.StationId">@station.StationName</option>
                        }
                    </select>
                </div>
                <div class="form-control-modern">
                    <label>Hạng mục</label>
                    <select>
                        <option>Kiểm tra cơ sở vật chất</option>
                        <option>Chuẩn bị khai trương mini</option>
                        <option>Bố trí khu trưng bày</option>
                        <option>Đào tạo sản phẩm</option>
                    </select>
                </div>
                <div class="form-control-modern">
                    <label>Ngày thực hiện</label>
                    <input type="date" />
                </div>
                <div class="form-control-modern">
                    <label>Ghi chú</label>
                    <input placeholder="Nhập thông tin cần phối hợp với team vận hành" />
                </div>
            </div>
            <div class="panel-actions">
                <button class="btn-secondary-soft">Lưu nháp</button>
                <button class="btn-primary-gradient">Gửi phân công</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <div>
                <h2>Cảnh báo vận hành</h2>
                <p>Tự động tổng hợp từ tồn kho station và trạng thái hoạt động.</p>
            </div>
        </div>
        <div class="panel-body">
            @if (Model.Alerts.Any())
            {
                <div class="list-modern">
                    @foreach (var alert in Model.Alerts)
                    {
                        <div class="list-item">
                            <span class="badge @alert.Severity">@alert.StationName</span>
                            <span>@alert.Message</span>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="crud-empty">
                    Tất cả station đang hoạt động ổn định.
                </div>
            }
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Nhật ký cập nhật station</h2>
            <p>Diễn biến mới nhất về tình trạng phục vụ và điều phối xe tại từng station.</p>
        </div>
    </div>
    <div class="panel-body">
        @if (Model.RecentUpdates.Any())
        {
            <div class="timeline">
                @foreach (var update in Model.RecentUpdates)
                {
                    <div class="timeline-item">
                        <h4>@update.Timestamp.ToLocalTime().ToString("dd/MM • HH:mm") • @update.StationName</h4>
                        <p>@update.Message</p>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="crud-empty">
                Chưa ghi nhận cập nhật nào.
            </div>
        }
    </div>
</div>
