@page "/evm/stations/access"
@model ElectricVehicleDealer.Presentation.Pages.Evm.Dealers.AccessModel
@using System.Linq
@{
    ViewData["Title"] = "Quản lý station - truy cập & vận hành";
    ViewData["PageTitle"] = "Quyền truy cập station";
    ViewData["PageDescription"] = "Theo dõi trạng thái hoạt động, liên hệ phụ trách và lịch sử cập nhật của từng station.";

    var totalStations = Model.Stations.Count;
    var activeStations = Model.ActiveStations;
    var inactiveStations = Model.InactiveStations;
    var recentStations = Model.RecentlyUpdatedStations;
    var totalVehicles = Model.Stations.Sum(s => s.TotalVehicles);
    var inactiveVehicles = Model.Stations.Sum(s => s.InactiveVehicles);
}

@section PageActions {
    <button class="btn-primary-gradient">Thêm station mới</button>
    <a class="btn-secondary-soft" asp-page="/Stations/Index">Mở trang quản trị station</a>
}

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Tổng quan station</h2>
            <p>Thống kê trạng thái mở bán và tồn kho đội xe theo dữ liệu mới nhất.</p>
        </div>
    </div>
    <div class="panel-body grid-3">
        <div class="stat-card">
            <span>Station đang mở bán</span>
            <h3>@activeStations/@totalStations</h3>
            <span class="kpi-trend">@inactiveStations station tạm ngưng</span>
        </div>
        <div class="stat-card">
            <span>Xe trưng bày trong mạng</span>
            <h3>@totalVehicles</h3>
            <span class="badge @(inactiveVehicles > 0 ? "warning" : "success")">
                @(inactiveVehicles > 0 ? $"{inactiveVehicles} xe tạm dừng" : "Tất cả xe đang hoạt động")
            </span>
        </div>
        <div class="stat-card">
            <span>Cập nhật trong 7 ngày</span>
            <h3>@recentStations</h3>
            <span class="kpi-trend">Station có cập nhật gần đây</span>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="panel soft">
        <div class="panel-body">
            <strong>@Model.StatusMessage</strong>
        </div>
    </div>
}

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Danh sách station</h2>
            <p>Quản lý liên hệ phụ trách, trạng thái phục vụ và tồn kho xe trưng bày.</p>
        </div>
    </div>
    <div class="panel-body">
        @if (Model.Stations.Any())
        {
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Station</th>
                        <th>Liên hệ</th>
                        <th>Xe hoạt động</th>
                        <th>Tổng xe</th>
                        <th>Mẫu xe</th>
                        <th>Cập nhật</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var station in Model.Stations)
                    {
                        var statusClass = station.IsActive ? "success" : "danger";
                        var toggleText = station.IsActive ? "Tạm ngưng" : "Mở lại";

                        <tr>
                            <td>
                                <strong>@station.StationName</strong>
                                <div class="text-muted">@station.Location</div>
                                <span class="badge @statusClass">@(station.IsActive ? "Đang phục vụ" : "Tạm ngưng")</span>
                            </td>
                            <td>
                                <div>@(string.IsNullOrWhiteSpace(station.ContactNumber) ? "Đang cập nhật" : station.ContactNumber)</div>
                                <form method="post" asp-page-handler="UpdateContact">
                                    <input type="hidden" name="stationId" value="@station.StationId" />
                                    <input type="text" name="contactNumber" value="@station.ContactNumber" placeholder="Nhập số liên hệ" />
                                    <button type="submit" class="btn-secondary-soft">Lưu liên hệ</button>
                                </form>
                            </td>
                            <td>@station.ActiveVehicles</td>
                            <td>@station.TotalVehicles</td>
                            <td>@station.ModelCount</td>
                            <td>@station.LastUpdated.ToLocalTime().ToString("dd/MM • HH:mm")</td>
                            <td>
                                <form method="post" asp-page-handler="ToggleStatus">
                                    <input type="hidden" name="stationId" value="@station.StationId" />
                                    <button type="submit" class="btn-primary-gradient">@toggleText</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="crud-empty">
                Chưa có station nào trong hệ thống. Vui lòng tạo station mới.
            </div>
        }
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Nhật ký station</h2>
            <p>Những cập nhật gần nhất về trạng thái phục vụ và tồn kho xe.</p>
        </div>
    </div>
    <div class="panel-body">
        @if (Model.Stations.Any())
        {
            var timeline = Model.Stations
                .OrderByDescending(s => s.LastUpdated)
                .Take(6)
                .ToList();

            <div class="timeline">
                @foreach (var entry in timeline)
                {
                    <div class="timeline-item">
                        <h4>@entry.LastUpdated.ToLocalTime().ToString("dd/MM • HH:mm") • @entry.StationName</h4>
                        <p>
                            @(entry.IsActive
                                ? entry.ActiveVehicles > 0
                                    ? $"Đang mở bán với {entry.ActiveVehicles} xe và {entry.ModelCount} mẫu."
                                    : "Đang mở bán nhưng chưa có xe trưng bày."
                                : "Station đang tạm ngưng phục vụ.")</p>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="crud-empty">
                Chưa có station nào để hiển thị nhật ký.
            </div>
        }
    </div>
</div>
