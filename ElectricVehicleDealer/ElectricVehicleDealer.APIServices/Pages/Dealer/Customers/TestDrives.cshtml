@page "/dealer/customers/testdrives"
@model ElectricVehicleDealer.Presentation.Pages.Dealer.Customers.TestDrivesModel
@using System.Globalization

@section Head {
    <link rel="stylesheet" href="~/css/manage/crud.css" />
}

<section class="crud-page" id="testdrives">
    <header class="crud-header">
        <div>
            <h2>Quản lý lịch lái thử</h2>
            <p>Theo dõi yêu cầu lái thử từ khách hàng, xác nhận và hoàn tất trải nghiệm tại trạm.</p>
        </div>
        <div class="crud-actions">
            <span class="crud-chip crud-chip--muted">Chờ xử lý: @Model.PendingCount</span>
            <span class="crud-chip">Đã xác nhận: @Model.ConfirmedCount</span>
            <span class="crud-chip">Hoàn tất: @Model.CompletedCount</span>
        </div>
    </header>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success">@Model.SuccessMessage</div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <div class="crud-table">
        @if (!Model.Schedules.Any())
        {
            <div class="crud-empty">Chưa có lịch lái thử nào được ghi nhận.</div>
        }
        else
        {
            <table class="crud-table__table crud-table__table--orders">
                <thead>
                    <tr>
                        <th class="crud-table__col-id">Mã</th>
                        <th>Khách hàng</th>
                        <th>Xe lái thử</th>
                        <th>Trạm</th>
                        <th>Thời gian</th>
                        <th>Trạng thái</th>
                        <th class="text-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var schedule in Model.Schedules)
                {
                    <tr class="crud-table__row">
                        <td class="crud-table__cell crud-table__cell--id">
                            <span class="crud-id-badge">#@schedule.ScheduleId</span>
                        </td>
                        <td class="crud-table__cell crud-table__cell--model">
                            <div class="crud-model">
                                <span class="crud-model__name">@schedule.CustomerUsername</span>
                                <span class="crud-model__meta">Đặt lúc @schedule.CreatedAt.ToLocalTime().ToString("dd/MM HH:mm")</span>
                            </div>
                        </td>
                        <td class="crud-table__cell">
                            <span class="crud-chip">@(!string.IsNullOrWhiteSpace(schedule.VehicleModel) ? schedule.VehicleModel : "Chưa xác định")</span>
                        </td>
                        <td class="crud-table__cell">
                            <div class="d-flex flex-column gap-1">
                                <span class="crud-meta">@schedule.StationName</span>
                                <span class="crud-meta crud-meta--muted">@(!string.IsNullOrWhiteSpace(schedule.StationLocation) ? schedule.StationLocation : "Đang cập nhật")</span>
                            </div>
                        </td>
                        <td class="crud-table__cell crud-table__cell--date">
                            <span class="crud-meta">@schedule.ScheduleTime.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                        </td>
                        <td class="crud-table__cell crud-table__cell--status">
                            <span class="crud-tag @Model.GetStatusClass(schedule.Status)">
                                @Model.GetStatusLabel(schedule.Status)
                            </span>
                        </td>
                        <td class="crud-table__cell crud-table__cell--actions text-end">
                            <div class="crud-table__actions">
                                @if (Model.CanConfirm(schedule.Status))
                                {
                                    <form method="post" asp-page-handler="UpdateStatus" asp-route-id="@schedule.ScheduleId" asp-route-status="Confirmed">
                                        <button type="submit" class="crud-icon-btn">
                                            <span class="crud-icon crud-icon--edit" aria-hidden="true"></span>
                                            <span>Xác nhận</span>
                                        </button>
                                    </form>
                                }
                                @if (Model.CanComplete(schedule.Status))
                                {
                                    <form method="post" asp-page-handler="UpdateStatus" asp-route-id="@schedule.ScheduleId" asp-route-status="Completed">
                                        <button type="submit" class="crud-icon-btn">
                                            <span class="crud-icon crud-icon--edit" aria-hidden="true"></span>
                                            <span>Hoàn tất</span>
                                        </button>
                                    </form>
                                }
                                @if (Model.CanCancel(schedule.Status))
                                {
                                    <form method="post" asp-page-handler="UpdateStatus" asp-route-id="@schedule.ScheduleId" asp-route-status="Cancelled">
                                        <button type="submit" class="crud-icon-btn crud-icon-btn--danger">
                                            <span class="crud-icon crud-icon--delete" aria-hidden="true"></span>
                                            <span>Huỷ</span>
                                        </button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
    </div>
</section>
