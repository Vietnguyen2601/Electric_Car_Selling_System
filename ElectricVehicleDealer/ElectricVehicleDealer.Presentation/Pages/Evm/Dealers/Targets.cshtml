@page "/evm/stations/fleet"
@model ElectricVehicleDealer.Presentation.Pages.Evm.Dealers.FleetModel
@using System.Linq
@{
    ViewData["Title"] = "Đội xe station - EVM";
    ViewData["PageTitle"] = "Quản lý đội xe trưng bày";
    ViewData["PageDescription"] = "Theo dõi tồn kho xe tại các station, tình trạng trưng bày và nhu cầu điều phối.";

    var activeVehicleCount = Model.StationInventories.Sum(i => i.ActiveQuantity);
    var suspendedVehicleCount = Model.StationInventories.Sum(i => i.SuspendedQuantity);
    var totalModels = Model.VehicleSummaries.Count;
}

@section PageActions {
    <button class="btn-primary-gradient">Lập điều phối xe</button>
    <button class="btn-secondary-soft">Xuất báo cáo tồn kho</button>
}

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Tổng quan đội xe</h2>
            <p>Số liệu đang mở bán tại các station dựa trên dữ liệu Station & StationCar.</p>
        </div>
    </div>
    <div class="panel-body grid-3">
        <div class="stat-card">
            <span>Xe trưng bày hoạt động</span>
            <h3>@activeVehicleCount</h3>
            <span class="kpi-trend">@Model.StationsWithInventory station có xe</span>
        </div>
        <div class="stat-card">
            <span>Xe tạm dừng/đang bảo dưỡng</span>
            <h3>@suspendedVehicleCount</h3>
            <span class="badge @(suspendedVehicleCount > 0 ? "warning" : "success")">
                @(suspendedVehicleCount > 0 ? "Cần kiểm tra lịch bảo dưỡng" : "Tất cả xe sẵn sàng")
            </span>
        </div>
        <div class="stat-card">
            <span>Mẫu xe theo dõi</span>
            <h3>@totalModels</h3>
            <span class="kpi-trend">
                @(Model.LowStockAssignments > 0
                    ? $"{Model.LowStockAssignments} phân bổ cảnh báo"
                    : "Không có cảnh báo tồn kho")
            </span>
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Phân bổ xe theo station</h2>
            <p>Cập nhật số lượng xe trưng bày và mẫu xe hoạt động tại từng station.</p>
        </div>
    </div>
    <div class="panel-body">
        @if (Model.StationInventories.Any())
        {
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Station</th>
                        <th>Mẫu hoạt động</th>
                        <th>Xe hoạt động</th>
                        <th>Xe tạm dừng</th>
                        <th>Chi tiết mẫu xe</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var station in Model.StationInventories)
                    {
                        var statusClass = station.IsActive
                            ? (station.HasLowStock ? "warning" : "success")
                            : "danger";

                        <tr>
                            <td>
                                <strong>@station.StationName</strong>
                                <div class="text-muted">@station.Location</div>
                            </td>
                            <td>@station.ActiveModels/@station.TotalModels</td>
                            <td>
                                <strong>@station.ActiveQuantity</strong>
                                @if (station.HasLowStock)
                                {
                                    <span class="badge warning">Tồn kho thấp</span>
                                }
                            </td>
                            <td>@station.SuspendedQuantity</td>
                            <td>
                                @if (station.Vehicles.Any())
                                {
                                    <div class="list-modern">
                                        @foreach (var vehicle in station.Vehicles)
                                        {
                                            <div class="list-item">
                                                <span>@vehicle.VehicleName</span>
                                                <span class="badge @(vehicle.IsActive ? "success" : "warning")">
                                                    @vehicle.Quantity xe
                                                </span>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">Chưa có phân bổ</span>
                                }
                            </td>
                            <td>
                                <span class="badge @statusClass">
                                    @(station.IsActive
                                        ? (station.ActiveQuantity > 0 ? "Đang mở bán" : "Chưa có xe trưng bày")
                                        : "Tạm ngưng")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="crud-empty">
                Chưa có dữ liệu phân bổ xe cho station.
            </div>
        }
    </div>
</div>

<div class="split-2">
    <div class="panel soft">
        <div class="panel-header">
            <div>
                <h2>Lập điều phối xe</h2>
                <p>Đề xuất chuyển xe giữa các station dựa trên tình trạng thực tế.</p>
            </div>
        </div>
        <div class="panel-body">
            <div class="form-grid">
                <div class="form-control-modern">
                    <label>Station nguồn</label>
                    <select>
                        @foreach (var station in Model.StationInventories)
                        {
                            <option value="@station.StationId">@station.StationName</option>
                        }
                    </select>
                </div>
                <div class="form-control-modern">
                    <label>Station nhận</label>
                    <select>
                        @foreach (var station in Model.StationInventories)
                        {
                            <option value="@station.StationId">@station.StationName</option>
                        }
                    </select>
                </div>
                <div class="form-control-modern">
                    <label>Mẫu xe</label>
                    <select>
                        @foreach (var vehicle in Model.VehicleSummaries)
                        {
                            <option value="@vehicle.VehicleName">@vehicle.VehicleName</option>
                        }
                    </select>
                </div>
                <div class="form-control-modern">
                    <label>Số lượng</label>
                    <input type="number" min="1" placeholder="Nhập số xe điều phối" />
                </div>
                <div class="form-control-modern">
                    <label>Ngày thực hiện</label>
                    <input type="date" />
                </div>
            </div>
            <div class="panel-actions">
                <button class="btn-secondary-soft">Lưu nháp</button>
                <button class="btn-primary-gradient">Gửi đề xuất</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <div>
                <h2>Tồn kho theo mẫu xe</h2>
                <p>Thống kê tổng số xe và mức độ phủ tại các station cho từng mẫu.</p>
            </div>
        </div>
        <div class="panel-body">
            @if (Model.VehicleSummaries.Any())
            {
                <table class="table-modern">
                    <thead>
                        <tr>
                            <th>Mẫu xe</th>
                            <th>Tổng xe</th>
                            <th>Station đang bán</th>
                            <th>Station cảnh báo</th>
                            <th>Trung bình/station</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var vehicle in Model.VehicleSummaries)
                        {
                            <tr>
                                <td>@vehicle.VehicleName</td>
                                <td>@vehicle.TotalQuantity</td>
                                <td>@vehicle.ActiveStations</td>
                                <td>
                                    <span class="badge @(vehicle.LowStockStations > 0 ? "warning" : "success")">
                                        @vehicle.LowStockStations
                                    </span>
                                </td>
                                <td>@vehicle.AveragePerStation</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="crud-empty">
                    Chưa có mẫu xe nào được phân bổ đến station.
                </div>
            }
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Ghi chú điều phối</h2>
            <p>Các đề xuất ưu tiên dựa trên tồn kho thực tế tại station.</p>
        </div>
    </div>
    <div class="panel-body">
        @if (Model.FocusNotes.Any())
        {
            <div class="list-modern">
                @foreach (var note in Model.FocusNotes)
                {
                    <div class="list-item">
                        <strong>@note.StationName</strong>
                        <span>@note.Message</span>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="crud-empty">
                Dữ liệu tồn kho đang cân bằng, chưa có ghi chú điều phối.
            </div>
        }
    </div>
</div>
